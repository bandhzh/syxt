<div class="row">
	<div class="col-md-12">
		<div class="portlet light portlet-fit portlet-datatable ">
			<div class="portlet-title">
				<div class="caption">
					<i class="icon-settings font-dark"></i> <span class="caption-subject font-dark sbold uppercase">报料管理</span>
				</div>
				<div class="actions">
					<div class="margin-bottom-5">
						<button class="btn btn-sm btn-success filter-submit margin-bottom">
							<i class="fa fa-search"></i> 查询
						</button>

						<!-- <button class="btn btn-sm btn-success add-submit  margin-bottom">
							<i class="fa fa-plus"></i> 新建
						</button> -->
						<button class="btn btn-sm btn-success remove-submit  margin-bottom">
							<i class="fa fa-remove"></i> 删除
						</button>
					</div>
				</div>

			</div>
			
			
				<div class="portlet-body">
					<div class="table-container">
						<table class="table table-striped table-bordered table-hover table-checkable" id="datatable_orders">
							<thead>
								<tr role="row" class="heading">
									<th width="30%">标题</th>
									<th width="15%">类别</th>
									<th width="15%">发布人</th>
									<th width="15%">联系方式</th>
									<th width="15%">发布时间</th>
									<th width="10%">状态</th><!-- 是否分发 -->
									
								</tr>
								<tr role="row" class="filter">
									<td><input type="text" class="form-control form-filter input-sm" columnName="baoliaoModel.title" operation="like"></td>
									<td><select id="typeids" class="form-control  form-filter selectpicker" columnName="baoliaoModel.typeid"></select></td>
									<td><input type="text" class="form-control form-filter input-sm" columnName="baoliaoModel.wxuserid" operation="like"></td>
									<td><input type="text" class="form-control form-filter input-sm" columnName="baoliaoModel.telphone" operation="like"></td>
									<td>
										<div class="form-group" style="margin-bottom: 0px;">
											<div class="input-group input-large date-picker input-daterange" data-date="2012-11-10" data-date-format="yyyy-mm-dd">
												<input type="text" class="form-control form-filter" name="baoliaoModel.createtime" operation=">="> 
												<span class="input-group-addon"> to </span> 
												<input type="text" class="form-control form-filter" name="baoliaoModel.createtime" operation="<=">
											</div>
										</div>
									</td>
									<td>
									<select class="form-control  form-filter selectpicker" columnName="baoliaoModel.isfenfa">
											<option value="" selected="selected">请选择...</option>
											<option value="-1">未分发</option>
											<option value="1">已分发</option>
									</select></td>
	
								</tr>
							</thead>
							<tbody>
								<tr>
									<td colspan="8">
										<div id="slickGrid" class="grid"></div>
										<div id="pager" class="om-grid om-widget om-widget-content" style="width: 100%; height: 30px;"></div>
									</td>
								</tr>

							</tbody>
						</table>
					</div>
				</div>

			
			
			</div>
			</div>
			</div>

			
			
			<!-- /.编辑信息 -->
			<div class="modal fade bs-modal-lg" id="large" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel">
				<div class="modal-dialog modal-lg">
					<div class="modal-content">
						<div class="modal-body">
							<div class="portlet-body form">
								<form action="#" class="horizontal-form" id="validationForm">
									<input type="hidden" class="form-control columnName" columnName="baoliaoModel.id">
									<div class="form-body">
										<h3 class="form-section batchHidden" style="margin-top: 0px;">基本信息</h3>
										<div class="row">
											<div class="col-md-6">
												<div class="form-group">
													<label>标题</label> <input type="text" name="subject" class="form-control columnName" columnName="baoliaoModel.title">
												</div>
											</div>

											<div class="col-md-12">
												<div class="form-group">
													<label>附件</label>
													<div class="input-group">
														<input type="hidden" class="form-control columnName" name="imgurl" id="imgurl" columnName="baoliaoModel.imgurl">
														<div id="imglistid">
															
														</div>
													</div>
												</div>
											</div>
											

											<div class="col-md-12">
												<div class="form-group">
													<label>报料内容</label>
													<textarea rows="12" cols="10" name="cont" class="form-control columnName" columnName="baoliaoModel.cont"></textarea>
												</div>
											</div>


										</div>

									</div>
								</form>
							</div>
						</div>


						<div class="modal-footer">
							<button type="button" class="btn dark btn-outline" data-dismiss="modal">关闭</button>
						</div>

					</div>
				</div>
			</div>
			
			

			<!-- 发起分发 -->
			<div class="modal fade bs-modal-sm" id="small2" tabindex="1" role="dialog" aria-labelledby="mySmallModalLabel">
				<div class="modal-dialog" role="document">
					<div class="modal-content">
						<div class="modal-header">
							<button type="button" class="close" data-dismiss="modal" aria-label="Close">
								<span aria-hidden="true">&times;</span>
							</button>
							<h4 class="modal-title">操作</h4>
						</div>
						<div class="modal-body">
							<div class="row">
								<div class="col-md-4">
									<div class="form-group">
										<label>类别</label>
										<input type="hidden" id="blid" name="blid"/>
										<select class="form-control selectpicker " controlType="select" id="newstype">
											<option value="选择类别">选择类别</option>
											<option value="舆论">舆论</option>
											<option value="马上办">马上办</option>
											<option value="安全">安全</option>
											<option value="信息">信息</option>
											<option value="新闻">新闻</option>
											<option value="信访">信访</option>
										</select>
									</div>
								</div>
								
								<div class="col-md-4">
									<div class="form-group">
										<label>是否需要核实</label> <select class="form-control selectpicker columnName" controlType="select" id="needVerify" ><option value="-1">否</option></select>
									</div>
								</div>
								
								<div class="col-md-3">
									<div class="form-group">
										<label>星级</label> <select class="form-control selectpicker columnName" controlType="select" id="levelIds2" ></select>
									</div>
								</div>
								
								
							</div>
							
								

						</div>

						<div class="modal-footer">
							<button type="button" class="btn dark btn-outline" data-dismiss="modal">关闭</button>
							<button type="button" class="btn green" id="saveForm2">保存</button>
						</div>

					</div>
				</div>
			</div>
			
			
				  
	  
	  
	  
	  
	  	

			<script>
				var myDataView, myGrid, pager, myDataView2, myGrid2, ue,userNodes = [],userTreeObj,_id;
				$(window).resize(function() {
					$("#slickGrid").width($("#slickGrid").parent().width());
					$("#slickGrid").height($(document).height() - 380);
					if (myGrid) {
						myGrid.resizeCanvas();
					}

				});
				
			    var setting2 = {
			  			check: {
			  				enable: true
			  			},
			  			data: {
			  				simpleData: {
			  					enable: true
			  				}
			  			}
			  		};
				
				$(document).ready(function() {
					$(window).resize();

					//selectInit("#mainTodo", "departments");
					//selectInit("#subTodo", "departments");

					$(".remove-submit").bind("click", function() {
						var items = myGrid.getSelectedRows();
						var ids = [];
						for (var i = 0; i < items.length; i++) {
							ids.push(myDataView.getItemByIdx(items[i])["id"]);
						}
						var params = {
							data : {
								"ids" : ids.toString()
							}
						};
						var _data = {
							data : JSON.stringify(params)
						};
						if (ids.length > 0) {
							$.ajax({
								url : "${ctxPath}/opinion/removeOpinion",
								type : "post",
								data : _data,
								success : function(data) {
									if (data.success) {
										pager.reload();
									} else {
										pager.reload();
									}
								}
							});
						}
					});

					selectInitList("#typeids", "lists", 1);
					selectInitList("#levelIds2", "lists", 2);
					
					
					for(var i = 0;i < initData["departments"].length;i++){
						  var j = initData["departments"][i];
						  userNodes.push({
							  id:"D" + j.id,
							  pId:"D" + j.pId,
							  name:j.label,
							  type:"D",
							  isParent:true
						  });
					}
					for(var i = 0;i < initData["users"].length;i++){
						var j = initData["users"][i];
						userNodes.push({
							  id:"D" + j.id,
							  pId:"D" + j.departmentId,
							  name:j.displayName,
							  type:"U",
							  isParent:false
						  });
					}
					userTreeObj = $.fn.zTree.init($("#userDepartTree"), setting2, userNodes);

					


					$(".filter-submit").bind("click", function() {
						var filterParameters = [];
						$(".form-filter").each(function() {
							if ($(this).val() != "") {
								var _operation = $(this).attr("operation");
								if (!_operation)
									_operation = "=";
								filterParameters.push({
									property : $(this).attr("columnName"),
									value : $(this).val(),
									operation : _operation
								});
							}
						});
						filterParameters.push({
							property : "baoliaoModel.isvalid",
							value : "Y",
							operation : "="
						});
						pager.setSearch(filterParameters);
						pager.setSort([ {
							"property" : "baoliaoModel.id",
							"order" : "desc"
						} ]);
						pager.reload();
					});

					myDataView = new Slick.Data.DataView({
						inlineFilters : true
					});
					myDataView.setItems([]);
					var options = {
						editable : false,
						enableAddRow : false,
						enableCellNavigation : true,
						enableColumnReorder : true,
						asyncEditorLoading : false,
						forceFitColumns : false,
						forceSyncScrolling : false,
						rowHeight : 30
					}

					var checkboxSelector = new Slick.CheckboxSelectColumn({
						cssClass : "slick-cell-checkboxsel"
					});

					var columnsSortable = [ checkboxSelector.getColumnDefinition(), {
						id : "title",
						name : "主题",
						width:300,
						field : "title",
						sortable : true,
						formatter : function(row, cell, value, columnDef, dataContext) {
							return "<a href='javascript:initEditData(\"" + row + "\");'  >" + value + "</a>";
						}
					}, {
						id : "lists",
						name : "类别",
						field : "typeid",
						formatter : listFormatter,
						width : 120,
						sortable : true
					}, {
						id : "wxuserid",
						name : "发布人",
						field : "wxuserid",
						width : 120,
						sortable : false
					}, {
						id : "createtime",
						name : "发布时间",
						field : "createtime",
						width : 150,
						formatter : dateFormatter,
						sortable : true
					}, {
						id : "telphone",
						name : "联系方式",
						field : "telphone",
						width : 120,
						sortable : false
					}, {
						id : "isfenfa",
						name : "状态",
						field : "isfenfa",
						width : 120,
						formatter : function(row, cell, value, columnDef, dataContext) {
							if (value == "-1") {
								return "待分发";
							} else if (value == "1") {
								return "已分发";
							}

						},
						sortable : true
					}, {
						id : "#",
						name : "操作",
						field : "#",
						width : 120,
						formatter : function(row, cell, value, columnDef, dataContext) {
							var _content = [];
							var status = dataContext.status;
							if(dataContext.isfenfa=="-1"){
								_content.push(String.format("<a href='javascript:initTodo({0});'>{1}</a>&nbsp;&nbsp;", dataContext.id, "分发"));
							}else{
								
							}
							
							//传参 报料id
							
							
							
							$("#blid").val(dataContext.id);

							return _content.join("");
						}
					} ];
					myGrid = new Slick.Grid("#slickGrid", myDataView, columnsSortable, options);
					myGrid.setSelectionModel(new Slick.RowSelectionModel());
					myGrid.registerPlugin(new Slick.AutoTooltips({
						enableForHeaderCells : true
					}));
					myGrid.registerPlugin(checkboxSelector);
					pager = new Slick.Controls.Pager(myDataView, myGrid, $("#pager"), {
						pagesize : 100,
						url : "${ctxPath}/baoliao/listOpinion"
					});
					$(".filter-submit").trigger("click");

					myDataView.onPagingInfoChanged.subscribe(function(e, pagingInfo) {
					});

					myDataView.onRowCountChanged.subscribe(function(e, args) {
						myGrid.updateRowCount();
						myGrid.render();
					});

					myDataView.onRowsChanged.subscribe(function(e, args) {
						myGrid.invalidateRows(args.rows);
						myGrid.render();
					});

					myGrid.onSort.subscribe(function(e, args) {
						var sorts = [];
						sorts.push({
							"property" : args.sortCol.field,
							"order" : args.sortAsc == true ? "asc" : "desc"
						});
						pager.setSort(sorts);
						$(".filter-submit").trigger("click");
					});

					myGrid.onScroll.subscribe(function(e, args) {
					});

					myGrid.onAddNewRow.subscribe(function(e, args) {
						var item = args.item;
						myGrid.invalidateRow(mainData.length);
						mainData.push(item);
						myGrid.updateRowCount();
						myGrid.render();
					});

					myDataView2 = new Slick.Data.DataView({
						inlineFilters : true
					});
					myDataView2.setItems([]);
					var columnsSortable2 = [ {
						id : "displayName",
						name : "参加者",
						field : "displayName",
						width : 140,
						sortable : false
					}, {
						id : "departmentName",
						name : "部门",
						field : "departmentName",
						width : 140,
						sortable : false
					}, {
						id : "createdDate",
						name : "时间",
						field : "createdDate",
						width : 150,
						formatter : dateFormatter,
						sortable : false
					}, {
						id : "memo",
						name : "内容",
						field : "memo",
						width : 250,
						sortable : false
					} ];

					
					//分发到相关新闻
					$("#saveForm2").click(function() {
						
						
							if($("#newstype").val() == "选择类别"){
								toastr.error("请选择类别");
							}else if($("#levelIds2").val()==""){
								toastr.error("请选择星级");
							}else{
								var blid = $("#blid").val();
								var newstype = $("#newstype").val();
								var needVerify = $("#needVerify").val();
								var levelIds2 = $("#levelIds2").val();
								var sourceId = 27;//网友报料
								var params = {
										data : {
											"newstype":newstype,
											"blid":blid,
											"needVerify":needVerify,
											"levelId":levelIds2,
											"sourceId":sourceId
										}
									};
									var _data = {
										data : JSON.stringify(params)
									};
								
									
									$.ajax({
										url : "${ctxPath}/baoliao/ajaxtofenfatype",
										type : "post",
										data : _data,
										success : function(data) {
											$('#small2').modal('hide');
											if (data.success) {
												pager.reload();
											} else {
												toastr.error(data.error);
											}
										}
									});
							}
					});
					
					
					
					
					
					
					
					
					

				});

				
				function initEditData(id) {
					var _data = myDataView.getItemByIdx(id);
					formInit({
						filter : "#validationForm .columnName",
						data : _data,
						modelName : "baoliaoModel"
					});
					
					
					var imgurl = $("#imgurl").val().split(",");
					$("#imglistid").html("");
					$.each(imgurl, function(i,val){ 
						if(i<imgurl.length-1){
							$("#imglistid").append('【'+(i+1)+'】<img align="absmiddle" style="max-width:80%;" src="'+window.qiniuDomainHttp+val+'" imagedefinionid="1"></br>');
						}
						
					});
					
					$('#large').modal('show');
				}
				
				
				
				
				
				function initVerify(id) {
					var _item = myDataView.getItemByIdx(id);
					var _items = initData["departments"];
					var inputOptions = [];
					for (var i = 0; i < _items.length; i++) {
						var j = _items[i];
						inputOptions.push({
							text : j.label,
							value : j.id
						});
					}

					bootbox.prompt({
						title : "请选择核实部门!",
						inputType : 'select',
						inputOptions : inputOptions,
						callback : function(result) {
							if (result) {
								var params = {
									data : {
										"id" : _item.id,
										"departmentId" : result
									}
								};
								var _data = {
									data : JSON.stringify(params)
								};
								$.ajax({
									url : "${ctxPath}/opinion/verifyOpinion",
									type : "post",
									data : _data,
									success : function(data) {
										$('#large').modal('hide');
										if (data.success) {
											pager.reload();
										} else {
											toastr.error(data.error);
										}
									}
								});
							}
							console.log(result);
						}
					});

				}

				function listVerifyFollerOpinion(id) {
					var _data = myDataView.getItemByIdx(id);

					var params = {
						data : {
							"opinionId" : _data["id"]
						}
					};

					var _item = {
						data : JSON.stringify(params)
					};

					$.ajax({
						url : "${ctxPath}/opinion/listVerifyFollerOpinion",
						type : "post",
						data : _item,
						success : function(data) {
							if (data.success) {
								myDataView2.setItems(data.data);
								myGrid2.render();
							}
							$('#small').modal('show');
						}
					});

				}

				function listTodoFollerOpinion(id) {
					var _data = myDataView.getItemByIdx(id);

					var params = {
						data : {
							"opinionId" : _data["id"]
						}
					};

					var _item = {
						data : JSON.stringify(params)
					};

					$.ajax({
						url : "${ctxPath}/opinion/listToDoFoller",
						type : "post",
						data : _item,
						success : function(data) {
							if (data.success) {
								myDataView2.setItems(data.data);
								myGrid2.render();
							}
							$('#small').modal('show');
						}
					});

				}

				function initTodo(id) {
				/* 	var _item = myDataView.getItemByIdx(id);
					var _items = initData["departments"];
					var inputOptions = [];
					for (var i = 0; i < _items.length; i++) {
						var j = _items[i];
						inputOptions.push({
							text : j.label,
							value : j.id
						});
					}
					$("#opinionToDoModelOpinionId").val(_item["id"]); */
					$("#small2").modal('show');
				}

				function initInstructionOpinion(id) {
					var _data = myDataView.getItemByIdx(id);
					var jsonData = {};

					bootbox.prompt({
						title : "批示",
						inputType : 'textarea',
						callback : function(result) {
							if ($.trim(result)) {
								jsonData["opinionInstructionModel.memo"] = result;
								jsonData["opinionInstructionModel.opinionId"] = _data["id"];
								var _url = "${ctxPath}/opinion/saveOpinionInstruction";
								$.ajax({
									url : _url,
									type : "post",
									data : jsonData,
									success : function(data) {
										$('#large').modal('hide');
										if (data.success) {
											pager.reload();
										} else {
											toastr.error(data.error);
										}
									}
								});
							}
						}
					});

				}

				function listInstructionOpinion(id) {
					var _data = myDataView.getItemByIdx(id);

					var params = {
						data : {
							"opinionId" : _data["id"]
						}
					};

					var _item = {
						data : JSON.stringify(params)
					};

					$.ajax({
						url : "${ctxPath}/opinion/listInstructionOpinion",
						type : "post",
						data : _item,
						success : function(data) {
							if (data.success) {
								myDataView2.setItems(data.data);
								myGrid2.render();
							}
							$('#small').modal('show');
						}
					});
				}
				
				function addOpinionUsers(id){
					_id = id;
					userTreeObj.checkAllNodes(false);
					$("#userSelect").modal('show');
				}
			</script>